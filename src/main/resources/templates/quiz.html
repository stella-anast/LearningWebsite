<!DOCTYPE html>
<html layout:decorate="Layouts/defaultLayout" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Quizzes</title>
    <link rel="icon" type="image/x-icon" href="/python-logo.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        .quiz-container {
            margin: 50px auto;
            max-width: 600px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #1F487E;
            color: white;
            border-top-left-radius: 15px !important;
            border-top-right-radius: 15px !important;
        }
        .btn-primary {
            background-color: #007bff;
            border: none;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body style="background-color: #B0C4DE" layout:fragment="content">

<div class="container quiz-container">
    <div class="card">
        <div class="card-header text-center">
            <h1>
                <span th:if="${quizId == 0}" th:text="'Wrong Answers Quiz'"></span>
                <span th:if="${quizId != 0}" th:text="'Quiz ' + ${quizId}"></span>
            </h1>
        </div>

        <div class="card-body">
            <hr>

            <!-- Check if the questions list is empty -->
            <div th:if="${questions.size() == 0}">
                <h3 class="text-center">There are no questions available for this quiz.</h3>
                <div class="text-center mt-4">
                    <a th:href="@{/api/{username}/quizzes(username=${username})}" class="btn btn-primary">Return to Quiz Area</a>
                </div>
            </div>

            <!-- Form and quiz pagination when questions exist -->
            <div th:if="${questions.size() > 0}">
                <form id="quizForm">
                    <!-- Dynamic Pages with 3 questions each -->
                    <div th:each="page, pageStat : ${#numbers.sequence(0, questions.size() / 3)}">
                        <div class="quiz-page" th:attr="id='page' + ${pageStat.index + 1}" th:style="${pageStat.index == 0} ? 'display:block;' : 'display:none;'">
                            <div th:each="question, stat : ${questions}">
                                <!-- Only show 3 questions per page -->
                                <div class="mb-3" th:if="${stat.index >= pageStat.index * 3 and stat.index < (pageStat.index + 1) * 3}">
                                    <h4 th:text="${stat.index + 1} + '. ' + ${question.question}"></h4>
                                    <div class="form-check" th:each="option : ${question.options}">
                                        <input class="form-check-input" type="radio" th:name="${question.id}" th:value="${option.optionText}" th:id="'q' + ${stat.index + 1} + 'a' + ${option.id}">
                                        <label class="form-check-label" th:for="'q' + ${stat.index + 1} + 'a' + ${option.id}" th:text="${option.optionText}"></label>
                                    </div>
                                </div>
                            </div>

                            <!-- Pagination Buttons -->
                            <div class="d-flex justify-content-end mt-3">
                                <button type="button" class="btn btn-secondary" th:if="${pageStat.index > 0}" th:onclick="'previousPage(' + (${pageStat.index}) + ')'">Previous</button>
                                <button type="button" class="btn btn-primary ml-2" th:if="${pageStat.index < questions.size() / 3}" th:onclick="'nextPage(' + (${pageStat.index + 2}) + ')'">Next</button>
                                <button type="button" class="btn btn-primary ml-2" th:if="${pageStat.index == questions.size() / 3}" data-bs-toggle="modal" data-bs-target="#submitModal">Submit</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <br>
    <div class="card" id="result-container" style="display:none;">
        <div class="card-body">
            <div id="result"></div>
        </div>
    </div>
</div>

    <!-- Modal -->
    <div class="modal fade" id="submitModal" tabindex="-1" role="dialog" aria-labelledby="submitModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="submitModalLongTitle">Submit Quiz</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you would like to submit your answers?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="closeModal" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitQuiz()">Submit</button>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const quizId = [[${quizId}]]; // Dynamic quiz ID
    const username = '[[${user.username}]]'; // Dynamic username

    // Function to go to the next page
    function nextPage(pageNumber) {
        document.querySelectorAll('.quiz-page').forEach(page => page.style.display = 'none');
        document.getElementById('page' + pageNumber).style.display = 'block';
    }

    // Function to go to the previous page
    function previousPage(pageNumber) {
        document.querySelectorAll('.quiz-page').forEach(page => page.style.display = 'none');
        document.getElementById('page' + pageNumber).style.display = 'block';
    }

    // Function to submit the quiz
    function submitQuiz() {
        const userAnswers = [];
        // Gather user answers
        document.querySelectorAll('input[type="radio"]:checked').forEach((input) => {
            const questionId = parseInt(input.name, 10); // Use question ID from the name attribute
            const selectedAnswer = input.value;
            userAnswers.push({ questionId: questionId, answer: selectedAnswer });
        });
        console.log(userAnswers)
        console.log(quizId)
        // Sending user answers to the server
        fetch(`/api/${username}/quiz/submit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                quizId: quizId,
                answers: userAnswers
            })
        })
            .then(response => response.json())
            .then(data => {
                // Handle success
                document.getElementById("closeModal").click();
                window.location.href = data.redirectUrl;
            })
            .catch(error => {
                document.getElementById("closeModal").click();
                document.getElementById("result-container").style.display = 'block';
                document.getElementById("result").innerHTML = `<h3>${error}</h3>`;
                console.error('Error:', error);
            });
    }
</script>
</body>
</html>
